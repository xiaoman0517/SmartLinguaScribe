
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šè¯­è¨€å¬å†™æµ‹éªŒç‹¬ç«‹åº”ç”¨</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Font Awesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- å¼•å…¥ XLSX åº“ç”¨äºæ–‡ä»¶å¯¼å‡º -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* è‡ªå®šä¹‰ Tailwind é…ç½® */
        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        .container-quiz {
            max-width: 700px;
        }
        .card-quiz {
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header-quiz {
            background: var(--primary);
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }
        .btn-primary-custom {
            background-color: var(--primary);
            border-color: var(--primary);
            transition: all 0.2s;
        }
        .btn-primary-custom:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.4);
        }
        .details-panel {
            background-color: #fffbeb; /* Light yellow background */
            border-left: 4px solid var(--warning);
            border-radius: 0.75rem;
        }
        .loading-spinner {
            color: white;
        }
        .voice-setting-box {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
        }
        .mode-btn.active {
            background-color: #007bff !important;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        }
        .mode-btn:not(.active) {
            background-color: #6c757d !important;
        }
        .hidden-content {
            opacity: 0;
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        .visible-content {
            opacity: 1;
            height: auto;
            overflow: visible;
        }
        .word-display {
            font-size: 2.5rem;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }
        .phonetic-display {
            font-size: 1.5rem;
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }
        .definition-display {
            font-size: 1.2rem;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .example-sentence-display {
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #4682b4;
        }
        /* ç¡®ä¿è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†åœ¨ç§»åŠ¨ç«¯å‹å¥½ */
        select, input[type="text"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='currentColor'%3e%3cpath d='M7 7l3 3 3-3m0 6l-3-3-3 3' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
        }
        /* å“åº”å¼æŒ‰é’®å¤§å° */
        .responsive-btn {
            padding: 0.75rem 1.5rem;
            font-size: 1.125rem;
        }
        @media (max-width: 640px) {
            .responsive-btn {
                padding: 0.5rem 1rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center">
    <div class="container-quiz w-full mx-auto mt-4 md:mt-10">
        <div class="card-quiz bg-white">
            <!-- å¤´éƒ¨ -->
            <div class="header-quiz p-6 text-white text-center">
                <h1 class="text-2xl md:text-3xl font-bold mb-1">
                    <i class="fas fa-headphones-alt mr-2"></i> å¤šè¯­è¨€å•è¯å­¦ä¹ ä¸æµ‹éªŒ
                </h1>
                <p class="text-sm opacity-90">Multilingual Word Learning & Quiz</p>
            </div>

            <div class="p-6">
                <!-- è¯­éŸ³åˆæˆè®¾ç½® - å±•å¼€å¼ -->
                <div class="mb-6 voice-setting-box p-4">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">
                        <i class="fas fa-cogs mr-2"></i> è¯­éŸ³è®¾ç½® (Amazon Polly)
                    </h2>
                    
                    <div class="flex flex-col sm:flex-row gap-3 mb-3">
                        <div class="w-full sm:w-1/2">
                            <label for="languageSelect" class="block text-sm font-medium text-gray-700">é€‰æ‹©è¯­è¨€:</label>
                            <select id="languageSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 disabled:bg-gray-100">
                                <!-- è¯­è¨€é€‰é¡¹ -->
                            </select>
                        </div>
                        <div class="w-full sm:w-1/2">
                            <label for="voiceSelect" class="block text-sm font-medium text-gray-700">é€‰æ‹©éŸ³è‰²:</label>
                            <div class="flex items-center mt-1">
                                <select id="voiceSelect" class="block w-full rounded-l-md border-gray-300 shadow-sm p-2.5 disabled:bg-gray-100">
                                    <option value="">åŠ è½½ä¸­...</option>
                                </select>
                                <span class="bg-gray-200 p-2.5 rounded-r-md" id="awsLoading">
                                    <i class="fas fa-spinner fa-spin text-gray-600"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ–‡ä»¶åŠ è½½å’Œç»Ÿè®¡åŒºåŸŸ -->
                <div class="flex flex-col sm:flex-row justify-between items-center mb-3 gap-3">
                    <button id="loadFileBtn" class="responsive-btn w-full sm:w-auto btn-primary-custom text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:shadow-xl transition duration-200">
                        <i class="fas fa-upload mr-2"></i> <span id="loadFileBtnText">åŠ è½½ Excel å•è¯è¡¨</span>
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="hidden">
                    
                    <div id="quizStats" class="text-center sm:text-right text-gray-700 w-full sm:w-auto">
                        <span class="bg-blue-100 text-blue-800 text-sm font-medium me-2 px-2.5 py-1 rounded-full">æ€»è®¡: 0</span>
                        <span class="bg-yellow-100 text-yellow-800 text-sm font-medium me-2 px-2.5 py-1 rounded-full">å‰©ä½™: 0</span>
                        <span class="bg-red-100 text-red-800 text-sm font-medium px-2.5 py-1 rounded-full">æœªæŒæ¡: 0</span>
                    </div>
                </div>

                <!-- æ¨¡å¼é€‰æ‹©å™¨ -->
                <div class="mt-4 flex justify-center gap-4 mb-6">
                    <button id="modeStudyBtn" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-all mode-btn active shadow-lg">
                        <i class="fas fa-book mr-2"></i> å­¦ä¹ æ¨¡å¼
                    </button>
                    <button id="modeQuizBtn" class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white rounded-lg font-semibold transition-all mode-btn shadow-lg">
                        <i class="fas fa-clipboard-check mr-2"></i> æµ‹è¯•æ¨¡å¼
                    </button>
                </div>

                <!-- å­¦ä¹ æ¨¡å¼å†…å®¹åŒº -->
                <div id="studyModeContent" class="text-center p-4 hidden">
                    <div id="studyInitialPrompt" class="mb-8">
                        <h3 class="text-xl font-medium text-gray-500 mb-2">è¯·å…ˆåŠ è½½ä¸€ä¸ªå•è¯è¡¨æ–‡ä»¶å¼€å§‹å­¦ä¹ ã€‚</h3>
                        <p class="text-sm text-gray-400">Excel æ–‡ä»¶åº”åŒ…å«å•è¯ã€éŸ³æ ‡ã€é‡Šä¹‰ã€ä¾‹å¥å’Œä¾‹å¥ç¿»è¯‘ç­‰åˆ—ã€‚</p>
                    </div>
                    
                    <div id="studyWordDisplayArea" style="display: none;">
                        <div class="word-display" id="studyCurrentWord"></div>
                        <div class="phonetic-display" id="studyCurrentPhonetic"></div>
                        
                        <div class="definition-display hidden-content" id="studyCurrentDefinition"></div>
                        <div class="example-sentence-display hidden-content" id="studyExampleSentenceArea">
                            <h6 class="text-lg font-semibold mb-2"><i class="fas fa-comment-dots"></i> ä¾‹å¥:</h6>
                            <div id="studyExampleSentence" class="text-lg italic text-blue-800 mb-2"></div>
                            <div id="studyExampleTranslation" class="text-base text-gray-700"></div>
                            <button class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg" id="studyPlayExampleBtn">
                                <i class="fas fa-volume-up mr-2"></i> æœ—è¯»ä¾‹å¥
                            </button>
                        </div>
                        
                        <div class="mt-6">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-blue-600 h-2.5 rounded-full" id="studyProgressBar" style="width: 0%"></div>
                            </div>
                            <div class="text-center mt-2 text-gray-600" id="studyProgressText">0/0</div>
                        </div>
                    </div>
                    
                    <!-- å­¦ä¹ æ¨¡å¼æ§åˆ¶æŒ‰é’® -->
                    <div class="mt-6 flex justify-center gap-4" id="studyControls">
                        <button class="responsive-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg disabled:opacity-50" id="studyPrevBtn" disabled>
                            <i class="fas fa-step-backward mr-2"></i> ä¸Šä¸€ä¸ª
                        </button>
                        <button class="responsive-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg disabled:opacity-50" id="studyPlayBtn" disabled>
                            <i class="fas fa-play mr-2"></i> æ’­æ”¾
                        </button>
                        <button class="responsive-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg disabled:opacity-50" id="studyNextBtn" disabled>
                            <i class="fas fa-step-forward mr-2"></i> ä¸‹ä¸€ä¸ª
                        </button>
                    </div>
                    
                    <!-- è‡ªåŠ¨æ’­æ”¾æ§åˆ¶ -->
                    <div class="mt-4 flex justify-center gap-4" id="studyAutoPlayControls">
                        <button class="responsive-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg disabled:opacity-50" id="studyAutoPlayBtn" disabled>
                            <i class="fas fa-sync-alt mr-2"></i> è‡ªåŠ¨æ’­æ”¾
                        </button>
                        <button class="responsive-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg disabled:opacity-50" id="studyAutoPlayWithExampleBtn" disabled>
                            <i class="fas fa-sync mr-2"></i> è‡ªåŠ¨æ’­æ”¾ï¼ˆå¸¦ä¾‹å¥ï¼‰
                        </button>
                    </div>
                    
                    <!-- æ’­æ”¾é—´éš”è®¾ç½® -->
                    <div class="mt-4 text-center">
                        <label class="text-gray-700">
                            <i class="fas fa-clock mr-2"></i> æ’­æ”¾é—´éš”(ç§’):
                            <input type="number" id="studyIntervalInput" class="ml-2 w-20 px-2 py-1 border rounded" value="2" min="1" max="10">
                        </label>
                    </div>
                </div>

                <!-- æµ‹éªŒæç¤ºåŒº -->
                <div id="quizModeContent" class="text-center p-4">
                    
                    <div id="initialPrompt" class="mb-8">
                        <h3 class="text-xl font-medium text-gray-500 mb-2">è¯·å…ˆåŠ è½½ä¸€ä¸ªå•è¯è¡¨æ–‡ä»¶å¼€å§‹æµ‹éªŒã€‚</h3>
                        <p class="text-sm text-gray-400">Excel æ–‡ä»¶åº”åŒ…å« 'word', 'phonetic', 'definition', 'example', 'exampleTranslation' ç­‰åˆ—ã€‚</p>
                    </div>

                    <h3 id="quizPrompt" class="text-2xl font-semibold text-gray-800 mb-6 hidden">ä½ è®¤è¯†è¿™ä¸ªå•è¯å—ï¼Ÿ</h3>
                    
                    <!-- æ’­æ”¾æŒ‰é’® -->
                    <button class="responsive-btn w-full sm:w-3/4 lg:w-1/2 mx-auto mb-6 text-white font-bold py-3 px-6 rounded-full shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-300 btn-primary-custom disabled:opacity-50" 
                            id="quizPlayButton" disabled>
                        <i class="fas fa-play mr-2"></i> æ’­æ”¾å‘éŸ³
                    </button>

                    <!-- æ–°å¢æ’­æ”¾ä¾‹å¥æŒ‰é’® -->
                    <button class="responsive-btn w-full sm:w-3/4 lg:w-1/2 mx-auto mb-6 text-white font-bold py-3 px-6 rounded-full shadow-xl focus:outline-none focus:ring-4 focus:ring-green-300 bg-green-500 hover:bg-green-600 disabled:opacity-50" 
                            id="quizPlayExampleButton" disabled>
                        <i class="fas fa-play mr-2"></i> æ’­æ”¾ä¾‹å¥
                    </button>

                    <!-- è®¤è¯†/ä¸è®¤è¯† æ§åˆ¶ -->
                    <div id="quizControls" class="flex gap-4 mb-6 hidden">
                        <button class="responsive-btn flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg focus:outline-none focus:ring-4 focus:ring-green-300 transition duration-200 disabled:opacity-50" 
                                id="quizKnowBtn">
                            <i class="fas fa-check mr-2"></i> æˆ‘è®¤è¯†
                        </button>
                        <button class="responsive-btn flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg focus:outline-none focus:ring-4 focus:ring-red-300 transition duration-200 disabled:opacity-50" 
                                id="quizUnknownBtn">
                            <i class="fas fa-times mr-2"></i> æˆ‘ä¸è®¤è¯†
                        </button>
                    </div>

                    <!-- å•è¯è¯¦æƒ…é¢æ¿ -->
                    <div id="quizDetailsPanel" class="details-panel p-4 mt-6 text-left hidden">
                        <h4 class="text-xl font-bold mb-3 text-gray-800" id="quizDetailsTitle">å•è¯è¯¦æƒ…</h4>
                        <div id="quizDetailsContent" class="text-gray-700 space-y-2 text-sm">
                            <!-- è¯¦æƒ…å†…å®¹åœ¨æ­¤å¤„å¡«å…… -->
                        </div>
                        <button class="responsive-btn w-full mt-4 btn-primary-custom text-white font-bold py-2.5 rounded-full focus:ring-2 focus:ring-blue-300" 
                                id="quizNextWordBtn">
                            <i class="fas fa-arrow-right mr-2"></i> ä¸‹ä¸€ä¸ªå•è¯
                        </button>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨æ“ä½œæ  -->
            <div class="p-6 pt-0 border-t border-gray-200">
                <button id="quizExportBtn" class="responsive-btn w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2.5 px-4 rounded-full transition duration-200 disabled:opacity-50">
                    <i class="fas fa-download mr-2"></i> å¯¼å‡ºæœªæŒæ¡çš„å•è¯
                </button>
            </div>

            <!-- éšè—çš„ Audio æ’­æ”¾å™¨ -->
            <audio id="audioPlayer"></audio>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒæ•°æ®ï¼šåº”ç”¨æ•°æ®å’Œå¤‡ä»½éŸ³è‰² ---
        
        // åº”ç”¨ç¨‹åºçš„ç¿»è¯‘å’Œç¤ºä¾‹æ•°æ®
        const ALL_APP_DATA = {
            "uiTranslations": {
                "zh-CN": {
                    "loadFileBtnText": "åŠ è½½ Excel å•è¯è¡¨",
                    "msgNoVoiceSelected": "è¯·é€‰æ‹©ä¸€ä¸ªéŸ³è‰²ï¼",
                    "msgBackendNoAudio": "åç«¯æœªè¿”å›éŸ³é¢‘æ•°æ®ã€‚",
                    "msgApiError": "è¯­éŸ³åˆæˆ API é”™è¯¯: {error}",
                    "msgLoadVoicesFailed": "åŠ è½½éŸ³è‰²å¤±è´¥: {error}",
                    "msgApiVoiceListFailed": "æ— æ³•ä» API è·å–éŸ³è‰²åˆ—è¡¨ï¼ŒçŠ¶æ€: {status}ï¼Œé”™è¯¯: {error}",
                    "msgApiVoiceListFormatError": "åç«¯è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘éŸ³è‰²åˆ—è¡¨ã€‚",
                    "msgApiVoiceListFailedFallback": "æ— æ³•åŠ è½½éŸ³è‰²åˆ—è¡¨ï¼ˆAPIè¿æ¥å¤±è´¥ï¼‰ã€‚å·²ä½¿ç”¨æœ¬åœ°å¤‡ç”¨éŸ³è‰²ï¼Œè¯­éŸ³åˆæˆåŠŸèƒ½å¯èƒ½å—é™ã€‚",
                    "msgNoWorksheet": "Excelæ–‡ä»¶ä¸­æ‰¾ä¸åˆ°å·¥ä½œè¡¨ã€‚",
                    "msgNoDataInSheet": "å·¥ä½œè¡¨ä¸­æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®è¡Œã€‚",
                    "msgExcelReadFailed": "Excel æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚",
                    "msgFileReaderError": "æ–‡ä»¶è¯»å–å™¨é”™è¯¯ã€‚",
                    "msgLoadingLanguages": "åŠ è½½è¯­è¨€...",
                    "msgLoadingVoices": "åŠ è½½éŸ³è‰²...",
                    "msgLoadFailed": "åŠ è½½å¤±è´¥",
                    "msgNoDataToDownload": "å¤ªæ£’äº†ï¼ç›®å‰æ²¡æœ‰ä¸è®¤è¯†çš„å•è¯å¯ä»¥å¯¼å‡ºã€‚",
                    "quizPlayButtonText": "æ’­æ”¾å‘éŸ³",
                    "quizPrompt": "ä½ è®¤è¯†è¿™ä¸ªå•è¯å—ï¼Ÿ",
                    "quizKnowBtnText": "æˆ‘è®¤è¯†",
                    "quizUnknownBtnText": "æˆ‘ä¸è®¤è¯†",
                    "quizDetailsTitle": "å•è¯è¯¦æƒ…",
                    "quizNextWordBtnText": "ä¸‹ä¸€ä¸ªå•è¯",
                    "quizExportBtnText": "å¯¼å‡ºæœªæŒæ¡çš„å•è¯",
                    "word": "å•è¯",
                    "phonetic": "éŸ³æ ‡",
                    "definition": "é‡Šä¹‰",
                    "exampleSentenceTitle": "ä¾‹å¥",
                    "exampleTranslation": "ä¾‹å¥ç¿»è¯‘",
                    "msgNoVoicesForLang": "æ­¤è¯­è¨€æˆ–å¼•æ“æ— å¯ç”¨éŸ³è‰²",
                    "msgAllWordsMastered": "ğŸ‰ æ­å–œä½ ï¼æ‰€æœ‰å•è¯éƒ½æŒæ¡äº†ï¼",
                    "msgSelectLanguage": "è¯·é€‰æ‹©è¯­è¨€",
                    "msgSelectVoice": "è¯·é€‰æ‹©éŸ³è‰²"
                }
            },
            "pollyLanguageDisplayNames": {
                "arb": "é˜¿æ‹‰ä¼¯è¯­",
                "ar-AE": "é˜¿æ‹‰ä¼¯è¯­ï¼ˆæµ·æ¹¾ï¼‰",
                "ca-ES": "åŠ æ³°ç½—å°¼äºšè¯­",
                "yue-CN": "ä¸­æ–‡ï¼ˆç²¤è¯­ï¼‰",
                "cmn-CN": "ä¸­æ–‡ï¼ˆæ™®é€šè¯ï¼‰",
                "cs-CZ": "æ·å…‹è¯­",
                "da-DK": "ä¸¹éº¦è¯­",
                "nl-BE": "è·å…°è¯­ï¼ˆæ¯”åˆ©æ—¶ï¼‰",
                "nl-NL": "è·å…°è¯­",
                "en-AU": "è‹±è¯­ï¼ˆæ¾³å¤§åˆ©äºšï¼‰",
                "en-GB": "è‹±è¯­ï¼ˆè‹±å›½ï¼‰",
                "en-IN": "è‹±è¯­ï¼ˆå°åº¦ï¼‰",
                "en-NZ": "è‹±è¯­ï¼ˆæ–°è¥¿å…°ï¼‰",
                "en-SG": "è‹±è¯­ï¼ˆæ–°åŠ å¡ï¼‰",
                "en-ZA": "è‹±è¯­ï¼ˆå—éï¼‰",
                "en-US": "è‹±è¯­ï¼ˆç¾å›½ï¼‰",
                "en-GB-WLS": "è‹±è¯­ï¼ˆå¨å°”å£«ï¼‰",
                "fi-FI": "èŠ¬å…°è¯­",
                "fr-FR": "æ³•è¯­",
                "fr-BE": "æ³•è¯­ï¼ˆæ¯”åˆ©æ—¶ï¼‰",
                "fr-CA": "æ³•è¯­ï¼ˆåŠ æ‹¿å¤§ï¼‰",
                "hi-IN": "å°åœ°è¯­",
                "de-DE": "å¾·è¯­",
                "de-AT": "å¾·è¯­ï¼ˆå¥¥åœ°åˆ©ï¼‰",
                "de-CH": "å¾·è¯­ï¼ˆç‘å£«ï¼‰",
                "is-IS": "å†°å²›è¯­",
                "it-IT": "æ„å¤§åˆ©è¯­",
                "ja-JP": "æ—¥è¯­",
                "ko-KR": "éŸ©è¯­",
                "nb-NO": "æŒªå¨è¯­",
                "pl-PL": "æ³¢å…°è¯­",
                "pt-BR": "è‘¡è„ç‰™è¯­ï¼ˆå·´è¥¿ï¼‰",
                "pt-PT": "è‘¡è„ç‰™è¯­ï¼ˆè‘¡è„ç‰™ï¼‰",
                "ro-RO": "ç½—é©¬å°¼äºšè¯­",
                "ru-RU": "ä¿„è¯­",
                "es-ES": "è¥¿ç­ç‰™è¯­ï¼ˆè¥¿ç­ç‰™ï¼‰",
                "es-MX": "è¥¿ç­ç‰™è¯­ï¼ˆå¢¨è¥¿å“¥ï¼‰",
                "es-US": "è¥¿ç­ç‰™è¯­ï¼ˆç¾å›½ï¼‰",
                "sv-SE": "ç‘å…¸è¯­",
                "tr-TR": "åœŸè€³å…¶è¯­",
                "cy-GB": "å¨å°”å£«è¯­"
            }
        };

        // --- API é…ç½® (è¯·æ ¹æ®æ‚¨çš„åç«¯è®¾ç½®æ›¿æ¢ URL) ---
        const API_GATEWAY_URL = 'https://7c5n6j1469.execute-api.us-east-1.amazonaws.com/dev';
        const LAMBDA_VOICES_URL = `${API_GATEWAY_URL}/voices`;
        const LAMBDA_SYNTHESIZE_URL = `${API_GATEWAY_URL}/synthesize`;

        // --- æµ‹éªŒæ¨¡å¼çŠ¶æ€ ---
        let allWordsData = [];      // ä» Excel åŠ è½½çš„æ‰€æœ‰å•è¯
        let currentQuizList = [];    // å½“å‰è¿™ä¸€è½®è¦æµ‹éªŒçš„å•è¯åˆ—è¡¨
        let unknownWordsList = [];   // åœ¨æœ¬è½®æµ‹éªŒä¸­ï¼Œæ ‡è®°ä¸ºâ€œä¸è®¤è¯†â€çš„å•è¯
        let currentQuizWord = null;  // å½“å‰æ­£åœ¨æµ‹éªŒçš„å•è¯å¯¹è±¡
        let allPollyVoices = [];     // å¯ç”¨éŸ³è‰²åˆ—è¡¨
        let isPlaying = false;       // æ’­æ”¾çŠ¶æ€é”
        
        // é»˜è®¤ç•Œé¢è¯­è¨€ä¸ºä¸­æ–‡
        var currentUILanguage = 'zh-CN'; 
        var t = ALL_APP_DATA.uiTranslations[currentUILanguage] || ALL_APP_DATA.uiTranslations['zh-CN'];
        
        // --- DOM å…ƒç´  ---
        // æ¨¡å¼åˆ‡æ¢
        const modeStudyBtn = document.getElementById('modeStudyBtn');
        const modeQuizBtn = document.getElementById('modeQuizBtn');
        const studyModeContent = document.getElementById('studyModeContent');
        const quizModeContent = document.getElementById('quizModeContent');
        
        // æ–‡ä»¶åŠ è½½
        const fileInput = document.getElementById('fileInput');
        const loadFileBtn = document.getElementById('loadFileBtn');
        
        // æµ‹éªŒæ¨¡å¼å…ƒç´ 
        const quizStats = document.getElementById('quizStats');
        const quizPlayButton = document.getElementById('quizPlayButton');
        const quizPlayExampleButton = document.getElementById('quizPlayExampleButton');
        const quizPrompt = document.getElementById('quizPrompt');
        const quizControls = document.getElementById('quizControls');
        const quizKnowBtn = document.getElementById('quizKnowBtn');
        const quizUnknownBtn = document.getElementById('quizUnknownBtn');
        const quizDetailsPanel = document.getElementById('quizDetailsPanel');
        const quizDetailsContent = document.getElementById('quizDetailsContent');
        const quizNextWordBtn = document.getElementById('quizNextWordBtn');
        const quizExportBtn = document.getElementById('quizExportBtn');
        const initialPrompt = document.getElementById('initialPrompt');
        
        // å­¦ä¹ æ¨¡å¼å…ƒç´ 
        const studyInitialPrompt = document.getElementById('studyInitialPrompt');
        const studyWordDisplayArea = document.getElementById('studyWordDisplayArea');
        const studyCurrentWord = document.getElementById('studyCurrentWord');
        const studyCurrentPhonetic = document.getElementById('studyCurrentPhonetic');
        const studyCurrentDefinition = document.getElementById('studyCurrentDefinition');
        const studyExampleSentenceArea = document.getElementById('studyExampleSentenceArea');
        const studyExampleSentence = document.getElementById('studyExampleSentence');
        const studyExampleTranslation = document.getElementById('studyExampleTranslation');
        const studyPlayExampleBtn = document.getElementById('studyPlayExampleBtn');
        const studyProgressBar = document.getElementById('studyProgressBar');
        const studyProgressText = document.getElementById('studyProgressText');
        const studyPrevBtn = document.getElementById('studyPrevBtn');
        const studyPlayBtn = document.getElementById('studyPlayBtn');
        const studyNextBtn = document.getElementById('studyNextBtn');
        const studyAutoPlayBtn = document.getElementById('studyAutoPlayBtn');
        const studyAutoPlayWithExampleBtn = document.getElementById('studyAutoPlayWithExampleBtn');
        const studyIntervalInput = document.getElementById('studyIntervalInput');
        
        // å…±äº«å…ƒç´ 
        const audioPlayer = document.getElementById('audioPlayer');
        const languageSelect = document.getElementById('languageSelect');
        const voiceSelect = document.getElementById('voiceSelect');
        const awsLoading = document.getElementById('awsLoading');
        
        // å­¦ä¹ æ¨¡å¼çŠ¶æ€
        let studyCurrentIndex = 0;
        let studyAutoPlayTimeoutId = null;
        let studyCurrentAutoPlayMode = 'none'; // 'none', 'wordOnly', 'wordWithExample'

        // --- è¾…åŠ©å‡½æ•° ---

        /**
         * å…·æœ‰æŒ‡æ•°é€€é¿çš„ fetch é‡è¯•æœºåˆ¶
         */
        async function fetchWithRetry(url, options = {}, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // å¦‚æœ HTTP çŠ¶æ€ç ä¸æ˜¯ 2xxï¼ŒæŠ›å‡ºé”™è¯¯
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 100; 
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
        }

        /**
         * æ˜¾ç¤ºæ¶ˆæ¯æ¡†
         */
        function showMessageBox(key, replacements = {}) {
            let message = t[key] || key;
            for (const placeholder in replacements) {
                message = message.replace(`{${placeholder}}`, replacements[placeholder]);
            }
            alert(message);
        }

        /**
         * æ•°ç»„ä¹±åº
         */
        function shuffleArray(array) {
            let newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šAmazon Polly æ’­æ”¾ ---
        
        async function playAmazonPolly(text, onEndedCallback = null) {
            if (!text || isPlaying) return Promise.resolve();

            const voiceId = voiceSelect.value;
            const languageCode = languageSelect.value;

            if (!voiceId) {
                showMessageBox('msgNoVoiceSelected');
                return Promise.resolve();
            }
            
            // UI çŠ¶æ€ï¼šæ’­æ”¾æŒ‰é’®ç¦ç”¨å’ŒåŠ è½½ä¸­ï¼ˆä»…æµ‹éªŒæ¨¡å¼ï¼‰
            const originalButtonContent = quizPlayButton ? quizPlayButton.innerHTML : '';
            if (quizPlayButton) {
                quizPlayButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2 loading-spinner"></i>`;
                quizPlayButton.disabled = true;
            }
            isPlaying = true;

            return new Promise(async (resolve, reject) => {
                try {
                    const response = await fetchWithRetry(LAMBDA_SYNTHESIZE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, voiceId, languageCode })
                    });

                    const data = await response.json();
                    
                    if (data.audioBase64) {
                        audioPlayer.src = `data:audio/mp3;base64,${data.audioBase64}`;
                        audioPlayer.play();

                        const onEnded = () => {
                            // æ’­æ”¾ç»“æŸæˆ–é”™è¯¯æ—¶æ¸…ç†çŠ¶æ€
                            if (quizPlayButton) {
                                quizPlayButton.innerHTML = originalButtonContent;
                                quizPlayButton.disabled = false;
                                if (quizPlayExampleButton && currentQuizWord) {
                                    quizPlayExampleButton.disabled = !currentQuizWord.example;
                                }
                            }
                            isPlaying = false;
                            if (onEndedCallback) {
                                onEndedCallback();
                            }
                            audioPlayer.removeEventListener('ended', onEnded);
                            audioPlayer.removeEventListener('error', onError);
                            resolve();
                        };
                        
                        const onError = (e) => {
                            console.error("Audio playback error:", e);
                            showMessageBox('msgApiError', { error: 'éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³è‰²å’Œç½‘ç»œã€‚' }); 
                            if (quizPlayButton) {
                                quizPlayButton.innerHTML = originalButtonContent;
                                quizPlayButton.disabled = false;
                            }
                            isPlaying = false;
                            audioPlayer.removeEventListener('ended', onEnded);
                            audioPlayer.removeEventListener('error', onError);
                            resolve(); // å³ä½¿å‡ºé”™ä¹Ÿ resolveï¼Œä¸é˜»å¡åç»­æµç¨‹
                        };

                        audioPlayer.addEventListener('ended', onEnded, { once: true });
                        audioPlayer.addEventListener('error', onError, { once: true });

                    } else {
                        throw new Error(t.msgBackendNoAudio);
                    }

                } catch (error) {
                    console.error("Error synthesizing speech:", error);
                    showMessageBox('msgApiError', { error: error.message });
                    if (quizPlayButton) {
                        quizPlayButton.innerHTML = originalButtonContent;
                        quizPlayButton.disabled = false;
                    }
                    isPlaying = false;
                    resolve(); // å³ä½¿å‡ºé”™ä¹Ÿ resolveï¼Œä¸é˜»å¡åç»­æµç¨‹
                }
            });
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæµ‹éªŒæµç¨‹ ---

        /**
         * å¯åŠ¨æ–°ä¸€è½®æµ‹éªŒ
         */
        function startQuizRound() {
            if (allWordsData.length === 0) {
                 showMessageBox('msgNoDataInSheet');
                 return;
            }

            // å¦‚æœæœ‰æœªæŒæ¡çš„å•è¯ï¼Œä¼˜å…ˆå¤ä¹ å®ƒä»¬
            if (unknownWordsList.length > 0) {
                currentQuizList = shuffleArray([...unknownWordsList]);
                unknownWordsList = []; // é‡ç½®æœªæŒæ¡åˆ—è¡¨ï¼Œè®©ç”¨æˆ·é‡æ–°æ ‡è®°
                console.log(`å¼€å§‹å¤ä¹  ${currentQuizList.length} ä¸ªæœªæŒæ¡çš„å•è¯ã€‚`);
            } else {
                // å¦åˆ™ï¼Œä½¿ç”¨æ‰€æœ‰å•è¯å¼€å§‹æ–°ä¸€è½®
                currentQuizList = shuffleArray([...allWordsData]);
                unknownWordsList = [];
                console.log(`å¼€å§‹æ–°ä¸€è½®æµ‹éªŒï¼Œæ€»è®¡ ${currentQuizList.length} ä¸ªå•è¯ã€‚`);
            }
            
            nextQuizWord();
            initialPrompt.classList.add('hidden');
            quizPrompt.classList.remove('hidden');
        }

        /**
         * åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæµ‹éªŒå•è¯
         */
        function nextQuizWord() {
            if (currentQuizList.length === 0) {
                currentQuizWord = null;
                updateQuizStats();
                // æœ¬è½®ç»“æŸ
                if (unknownWordsList.length > 0) {
                    // å¦‚æœæœ‰æ–°çš„æœªæŒæ¡å•è¯ï¼Œå¼€å§‹æ–°çš„å¤ä¹ è½®æ¬¡
                    startQuizRound(); 
                } else {
                    // æ‰€æœ‰å•è¯éƒ½æŒæ¡äº†
                    quizPrompt.textContent = t.msgAllWordsMastered;
                    quizPlayButton.classList.add('hidden');
                    quizPlayExampleButton.classList.add('hidden');
                    quizControls.classList.add('hidden');
                    quizDetailsPanel.classList.add('hidden');
                }
                return;
            }

            // éšæœºæŠ½å–ä¸€ä¸ªå•è¯
            const randomIndex = Math.floor(Math.random() * currentQuizList.length);
            currentQuizWord = currentQuizList.splice(randomIndex, 1)[0]; 
            
            resetQuizUI();
            
            // è‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€æ¬¡å‘éŸ³ï¼Œå¹¶åœ¨ç»“æŸåæ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
            playAmazonPolly(currentQuizWord.word, () => {
                quizControls.classList.remove('hidden');
            });
        }

        /**
         * é‡ç½®æµ‹éªŒUIçŠ¶æ€
         */
        function resetQuizUI() {
            quizDetailsPanel.classList.add('hidden');
            quizDetailsContent.innerHTML = '';
            quizControls.classList.add('hidden'); 
            
            quizPlayButton.classList.remove('hidden');
            quizPlayButton.disabled = false;
            if (currentQuizWord && currentQuizWord.example) {
                quizPlayExampleButton.classList.remove('hidden');
                quizPlayExampleButton.disabled = false;
            } else {
                quizPlayExampleButton.classList.add('hidden');
            }
            quizKnowBtn.disabled = false;
            quizUnknownBtn.disabled = false;
            quizPrompt.textContent = t.quizPrompt;

            // æ¢å¤æ’­æ”¾æŒ‰é’®çš„åŸå§‹æ–‡æœ¬
            quizPlayButton.innerHTML = `<i class="fas fa-play mr-2"></i> ${t.quizPlayButtonText}`;

            updateQuizStats();
            
            // é‡æ–°ç»‘å®šæ’­æ”¾æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            quizPlayButton.onclick = () => {
                playAmazonPolly(currentQuizWord.word, () => {
                    quizControls.classList.remove('hidden');
                });
            };
        }

        /**
         * æ›´æ–°æµ‹éªŒç»Ÿè®¡æ•°æ®
         */
        function updateQuizStats() {
            const totalWords = allWordsData.length;
            const remainingInRound = currentQuizList.length + (currentQuizWord ? 1 : 0);
            
            quizStats.innerHTML = `
                <span class="bg-blue-100 text-blue-800 text-sm font-medium me-2 px-2.5 py-1 rounded-full">æ€»è®¡: ${totalWords}</span>
                <span class="bg-yellow-100 text-yellow-800 text-sm font-medium me-2 px-2.5 py-1 rounded-full">å‰©ä½™: ${remainingInRound}</span>
                <span class="bg-red-100 text-red-800 text-sm font-medium px-2.5 py-1 rounded-full">æœªæŒæ¡: ${unknownWordsList.length}</span>
            `;
        }

        /**
         * æ˜¾ç¤ºå•è¯è¯¦æƒ…
         */
        function showQuizDetails(isKnown) {
            const word = currentQuizWord;
            const statusMessage = isKnown ? 
                '<span class="text-green-600 font-bold">âœ“ å›ç­”æ­£ç¡®ï¼</span>' : 
                '<span class="text-red-600 font-bold">âœ— éœ€è¦å¤ä¹ ï¼</span>';
                
            const detailsHtml = `
                <p class="mb-3 text-lg">${statusMessage}</p>
                <div class="space-y-2">
                    <p><strong>${t.word}:</strong> <span class="text-xl font-bold text-blue-800">${word.word || 'N/A'}</span> (<span class="text-gray-500">${word.phonetic || 'N/A'}</span>)</p>
                    <p><strong>${t.definition}:</strong> ${word.definition || 'N/A'}</p>
                    <p><strong>${t.exampleSentenceTitle}:</strong> ${word.example || 'N/A'}</p>
                    <p><strong>${t.exampleTranslation}:</strong> ${word.exampleTranslation || 'N/A'}</p>
                </div>
            `;
            quizDetailsContent.innerHTML = detailsHtml;
            quizDetailsPanel.classList.remove('hidden');

            // ç¦ç”¨å½“å‰æ“ä½œæŒ‰é’®
            quizKnowBtn.disabled = true;
            quizUnknownBtn.disabled = true;
            quizPlayButton.disabled = true; 
            quizPrompt.classList.add('hidden');
        }

        function handleKnow() {
            showQuizDetails(true);
        }

        function handleUnknown() {
            unknownWordsList.push(currentQuizWord);
            showQuizDetails(false);
        }

        // --- æ–‡ä»¶å’Œæ•°æ®å¤„ç† ---

        /**
         * ä» Excel/CSV æ–‡ä»¶åŠ è½½å•è¯æ•°æ®
         */
        function loadDataFromExcel(file) {
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    
                    if (!firstSheetName) {
                        showMessageBox('msgNoWorksheet');
                        return;
                    }
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                    if (rows.length === 0) {
                        showMessageBox('msgNoDataInSheet');
                        return;
                    }
                    
                    const nonEmptyRows = rows.filter(row =>
                        row.some(cell => (cell !== undefined && cell !== null && `${cell}`.trim() !== ''))
                    );

                    if (nonEmptyRows.length === 0) {
                        showMessageBox('msgNoDataInSheet');
                        return;
                    }

                    const headerKeywords = ['word', 'å•è¯', 'phonetic', 'éŸ³æ ‡', 'definition', 'é‡Šä¹‰', 'example', 'ä¾‹å¥', 'exampletranslation', 'ä¾‹å¥ç¿»è¯‘'];
                    const firstRow = nonEmptyRows[0].map(cell => `${cell}`.trim().toLowerCase());
                    const hasHeader = firstRow.some(cell => headerKeywords.includes(cell));
                    const dataRows = hasHeader ? nonEmptyRows.slice(1) : nonEmptyRows;

                    allWordsData = dataRows.map(row => {
                        const [word = '', phonetic = '', definition = '', example = '', exampleTranslation = ''] = row;
                        return {
                            word: `${word}`.trim(),
                            phonetic: `${phonetic}`.trim(),
                            definition: `${definition}`.trim(),
                            example: `${example}`.trim(),
                            exampleTranslation: `${exampleTranslation}`.trim()
                        };
                    }).filter(item => item.word);
                    
                    if (allWordsData.length === 0) {
                        showMessageBox('msgNoDataInSheet');
                        return;
                    }
                    
                    // åŠ è½½æˆåŠŸåï¼Œæ ¹æ®å½“å‰æ¨¡å¼åˆå§‹åŒ–
                    if (currentMode === 'study') {
                        studyCurrentIndex = 0;
                        displayStudyWord();
                    } else {
                        quizPlayButton.disabled = false;
                        startQuizRound();
                    } 

                } catch (error) {
                    console.error(error);
                    showMessageBox('msgExcelReadFailed');
                }
            };
            
            reader.onerror = () => {
                showMessageBox('msgFileReaderError');
            };
            
            reader.readAsArrayBuffer(file);
        }

        /**
         * å¤„ç†æ–‡ä»¶é€‰æ‹©äº‹ä»¶ï¼ˆinput[type=file] çš„ change å›è°ƒï¼‰
         */
        function handleFileSelect(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) {
                return;
            }
            loadDataFromExcel(file);
        }

        /**
         * å¯¼å‡ºæœªæŒæ¡çš„å•è¯
         */
        function exportUnknownWords() {
            if (unknownWordsList.length === 0) {
                showMessageBox('msgNoDataToDownload');
                return;
            }

            const headers = ["word", "phonetic", "definition", "example", "exampleTranslation"];
            
            const dataForSheet = unknownWordsList.map(word => {
                let row = {};
                headers.forEach(header => {
                    row[header] = word[header] || ''; 
                });
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(dataForSheet, { 
                header: headers,
                // é‡å‘½åè¡¨å¤´ä¸ºä¸­æ–‡
                headerMap: {
                    "word": "å•è¯",
                    "phonetic": "éŸ³æ ‡",
                    "definition": "é‡Šä¹‰",
                    "example": "ä¾‹å¥",
                    "exampleTranslation": "ä¾‹å¥ç¿»è¯‘"
                }
            });
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "æœªæŒæ¡çš„å•è¯");
            
            XLSX.writeFile(wb, "my_unknown_words.xlsx");
        }

        // --- ä¸€äº›æ—§ç‰ˆæœ¬ä¸­ä½¿ç”¨åˆ°çš„å›è°ƒå°è£…ï¼Œä¿æŒäº‹ä»¶ç»‘å®šä¸æŠ¥é”™ ---

        /**
         * æ’­æ”¾å½“å‰å•è¯å‘éŸ³ï¼ˆä¾›æ’­æ”¾æŒ‰é’®ç»‘å®šä½¿ç”¨ï¼‰
         */
        function playCurrentWordPronunciation() {
            if (!currentQuizWord) {
                return;
            }
            playAmazonPolly(currentQuizWord.word, () => {
                quizControls.classList.remove('hidden');
            });
        }

        // æ–°å¢æ’­æ”¾ä¾‹å¥å‡½æ•°
        function playCurrentExamplePronunciation() {
            if (!currentQuizWord || !currentQuizWord.example) return;
            playAmazonPolly(currentQuizWord.example, () => {
                quizControls.classList.remove('hidden');
            });
        }

        /**
         * æ ¹æ®æ˜¯å¦è®¤è¯†å•è¯å¤„ç†ç­”é¢˜ç»“æœ
         */
        function handleWordKnowledge(isKnown) {
            if (isKnown) {
                handleKnow();
            } else {
                handleUnknown();
            }
        }

        /**
         * åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæµ‹éªŒå•è¯ï¼ˆä¾›â€œä¸‹ä¸€ä¸ªå•è¯â€æŒ‰é’®ç»‘å®šä½¿ç”¨ï¼‰
         */
        function startNextQuizWord() {
            nextQuizWord();
        }

        // --- è¯­éŸ³è®¾ç½®é€»è¾‘ ---

        /**
         * ä»åç«¯ API åŠ è½½ Polly è¯­è¨€å’ŒéŸ³è‰²ï¼Œé€»è¾‘ä¸ player.html ä¿æŒä¸€è‡´ã€‚
         */
        async function loadAllPollyLanguagesAndVoices() {
            const loadingLanguages = t.msgLoadingLanguages || 'åŠ è½½è¯­è¨€...';
            const loadingVoices = t.msgLoadingVoices || 'åŠ è½½éŸ³è‰²...';

            languageSelect.innerHTML = `<option value="">${loadingLanguages}</option>`;
            voiceSelect.innerHTML = `<option value="">${loadingVoices}</option>`;
            if (awsLoading) {
                awsLoading.classList.remove('hidden');
            }

            try {
                const response = await fetch(LAMBDA_VOICES_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    const messageTemplate = t.msgApiVoiceListFailed || 'æ— æ³•åŠ è½½éŸ³è‰²åˆ—è¡¨ï¼ŒçŠ¶æ€: {status}ï¼Œé”™è¯¯: {error}';
                    throw new Error(
                        messageTemplate
                            .replace('{status}', response.status)
                            .replace('{error}', errorText || 'æœªçŸ¥é”™è¯¯')
                    );
                }

                const data = await response.json();
                if (!data || !Array.isArray(data.Voices)) {
                    throw new Error(t.msgApiVoiceListFormatError || 'åç«¯è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘éŸ³è‰²åˆ—è¡¨ã€‚');
                }

                allPollyVoices = data.Voices;
                populatePollyLanguageSelector();
            } catch (error) {
                console.error('Failed to load all Polly languages and voices:', error);
                const loadFailedText = t.msgLoadFailed || 'åŠ è½½å¤±è´¥';
                languageSelect.innerHTML = `<option value="">${loadFailedText}</option>`;
                voiceSelect.innerHTML = `<option value="">${loadFailedText}</option>`;
                showMessageBox('msgLoadVoicesFailed', { error: error.message });
            } finally {
                if (awsLoading) {
                    awsLoading.classList.add('hidden');
                }
            }
        }

        // --- æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ ---
        
        let currentMode = 'study'; // 'study' æˆ– 'quiz'
        
        function switchMode(mode) {
            // åœæ­¢å­¦ä¹ æ¨¡å¼çš„è‡ªåŠ¨æ’­æ”¾
            if (currentMode === 'study') {
                stopStudyAutoPlay();
            }
            
            currentMode = mode;
            
            if (mode === 'study') {
                modeStudyBtn.classList.add('active');
                modeStudyBtn.classList.remove('bg-gray-400', 'hover:bg-gray-500');
                modeStudyBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                modeQuizBtn.classList.remove('active');
                modeQuizBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                modeQuizBtn.classList.add('bg-gray-400', 'hover:bg-gray-500');
                studyModeContent.classList.remove('hidden');
                quizModeContent.classList.add('hidden');
                quizExportBtn.parentElement.classList.add('hidden');
                quizStats.classList.add('hidden');
            } else {
                modeStudyBtn.classList.remove('active');
                modeStudyBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                modeStudyBtn.classList.add('bg-gray-400', 'hover:bg-gray-500');
                modeQuizBtn.classList.add('active');
                modeQuizBtn.classList.remove('bg-gray-400', 'hover:bg-gray-500');
                modeQuizBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                studyModeContent.classList.add('hidden');
                quizModeContent.classList.remove('hidden');
                quizExportBtn.parentElement.classList.remove('hidden');
                quizStats.classList.remove('hidden');
            }
            
            // å¦‚æœå·²åŠ è½½æ•°æ®ï¼Œæ›´æ–°æ˜¾ç¤º
            if (allWordsData.length > 0) {
                if (mode === 'study') {
                    displayStudyWord();
                } else {
                    // åˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼æ—¶ï¼Œå¦‚æœè¿˜æ²¡æœ‰å¼€å§‹æµ‹éªŒï¼Œåˆ™åˆå§‹åŒ–æµ‹éªŒ
                    if (currentQuizList.length === 0 && unknownWordsList.length === 0) {
                        quizPlayButton.disabled = false;
                        startQuizRound();
                    } else {
                        // å¦‚æœå·²ç»åœ¨æµ‹éªŒä¸­ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                        updateQuizStats();
                    }
                }
            }
        }
        
        // --- å­¦ä¹ æ¨¡å¼åŠŸèƒ½ ---
        
        function displayStudyWord() {
            if (allWordsData.length === 0) {
                studyWordDisplayArea.style.display = 'none';
                studyInitialPrompt.classList.remove('hidden');
                return;
            }
            
            const word = allWordsData[studyCurrentIndex];
            if (!word) return;
            
            studyInitialPrompt.classList.add('hidden');
            studyWordDisplayArea.style.display = 'block';
            
            studyCurrentWord.textContent = word.word || '';
            studyCurrentPhonetic.textContent = word.phonetic || '';
            
            // æ˜¾ç¤ºé‡Šä¹‰
            if (word.definition) {
                studyCurrentDefinition.textContent = word.definition;
                studyCurrentDefinition.classList.remove('hidden-content');
                studyCurrentDefinition.classList.add('visible-content');
            } else {
                studyCurrentDefinition.classList.add('hidden-content');
                studyCurrentDefinition.classList.remove('visible-content');
            }
            
            // æ˜¾ç¤ºä¾‹å¥
            if (word.example) {
                studyExampleSentence.textContent = word.example;
                studyExampleTranslation.textContent = word.exampleTranslation || '';
                studyExampleSentenceArea.classList.remove('hidden-content');
                studyExampleSentenceArea.classList.add('visible-content');
                studyPlayExampleBtn.disabled = false;
            } else {
                studyExampleSentenceArea.classList.add('hidden-content');
                studyExampleSentenceArea.classList.remove('visible-content');
                studyPlayExampleBtn.disabled = true;
            }
            
            updateStudyProgress();
            updateStudyButtons();
        }
        
        function updateStudyProgress() {
            if (allWordsData.length === 0) {
                studyProgressBar.style.width = '0%';
                studyProgressText.textContent = '0/0';
                return;
            }
            const progress = ((studyCurrentIndex + 1) / allWordsData.length) * 100;
            studyProgressBar.style.width = `${progress}%`;
            studyProgressText.textContent = `${studyCurrentIndex + 1}/${allWordsData.length}`;
        }
        
        function updateStudyButtons() {
            studyPrevBtn.disabled = studyCurrentIndex === 0;
            studyNextBtn.disabled = studyCurrentIndex >= allWordsData.length - 1;
            studyPlayBtn.disabled = allWordsData.length === 0;
            studyAutoPlayBtn.disabled = allWordsData.length === 0;
            studyAutoPlayWithExampleBtn.disabled = allWordsData.length === 0;
        }
        
        async function playStudyWord() {
            if (allWordsData.length === 0) return;
            const word = allWordsData[studyCurrentIndex];
            if (!word || !word.word) return;
            
            // å…ˆåªæ˜¾ç¤ºå•è¯å’ŒéŸ³æ ‡
            studyCurrentDefinition.classList.add('hidden-content');
            studyExampleSentenceArea.classList.add('hidden-content');
            
            // æ’­æ”¾å•è¯
            await playAmazonPolly(word.word);
            
            // æ’­æ”¾åæ˜¾ç¤ºé‡Šä¹‰å’Œä¾‹å¥
            if (word.definition) {
                studyCurrentDefinition.classList.remove('hidden-content');
                studyCurrentDefinition.classList.add('visible-content');
            }
            if (word.example) {
                studyExampleSentenceArea.classList.remove('hidden-content');
                studyExampleSentenceArea.classList.add('visible-content');
            }
        }
        
        async function playStudyWordWithExample() {
            if (allWordsData.length === 0) return;
            const word = allWordsData[studyCurrentIndex];
            if (!word || !word.word) return;
            
            // å…ˆåªæ˜¾ç¤ºå•è¯å’ŒéŸ³æ ‡
            studyCurrentDefinition.classList.add('hidden-content');
            studyExampleSentenceArea.classList.add('hidden-content');
            
            // æ’­æ”¾å•è¯
            await playAmazonPolly(word.word);
            
            // æ˜¾ç¤ºé‡Šä¹‰
            if (word.definition) {
                studyCurrentDefinition.classList.remove('hidden-content');
                studyCurrentDefinition.classList.add('visible-content');
            }
            
            // æ’­æ”¾ä¾‹å¥
            if (word.example) {
                studyExampleSentenceArea.classList.remove('hidden-content');
                studyExampleSentenceArea.classList.add('visible-content');
                await playAmazonPolly(word.example);
            }
        }
        
        function stopStudyAutoPlay() {
            if (studyAutoPlayTimeoutId) {
                clearTimeout(studyAutoPlayTimeoutId);
                studyAutoPlayTimeoutId = null;
            }
            studyCurrentAutoPlayMode = 'none';
            updateStudyAutoPlayButtons();
        }
        
        function updateStudyAutoPlayButtons() {
            if (studyCurrentAutoPlayMode === 'wordOnly') {
                studyAutoPlayBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                studyAutoPlayBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                studyAutoPlayBtn.innerHTML = '<i class="fas fa-pause mr-2"></i> åœæ­¢è‡ªåŠ¨æ’­æ”¾';
            } else if (studyCurrentAutoPlayMode === 'wordWithExample') {
                studyAutoPlayWithExampleBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                studyAutoPlayWithExampleBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                studyAutoPlayWithExampleBtn.innerHTML = '<i class="fas fa-pause mr-2"></i> åœæ­¢è‡ªåŠ¨æ’­æ”¾';
            } else {
                studyAutoPlayBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                studyAutoPlayBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                studyAutoPlayBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> è‡ªåŠ¨æ’­æ”¾';
                studyAutoPlayWithExampleBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                studyAutoPlayWithExampleBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                studyAutoPlayWithExampleBtn.innerHTML = '<i class="fas fa-sync mr-2"></i> è‡ªåŠ¨æ’­æ”¾ï¼ˆå¸¦ä¾‹å¥ï¼‰';
            }
        }
        
        async function startStudyAutoPlay(mode) {
            stopStudyAutoPlay();
            studyCurrentAutoPlayMode = mode;
            updateStudyAutoPlayButtons();
            
            const playNext = async () => {
                if (studyCurrentAutoPlayMode === 'none') return;
                
                if (mode === 'wordOnly') {
                    await playStudyWord();
                } else {
                    await playStudyWordWithExample();
                }
                
                // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª
                if (studyCurrentIndex < allWordsData.length - 1) {
                    studyCurrentIndex++;
                    displayStudyWord();
                } else {
                    // å¾ªç¯åˆ°å¼€å¤´
                    studyCurrentIndex = 0;
                    displayStudyWord();
                }
                
                if (studyCurrentAutoPlayMode !== 'none') {
                    const interval = parseInt(studyIntervalInput.value) || 2;
                    studyAutoPlayTimeoutId = setTimeout(playNext, interval * 1000);
                }
            };
            
            await playNext();
        }
        
        // --- ç»‘å®šäº‹ä»¶å’Œåˆå§‹åŒ– ---

        function initializeApp() {
            // æ¨¡å¼åˆ‡æ¢äº‹ä»¶
            modeStudyBtn.addEventListener('click', () => switchMode('study'));
            modeQuizBtn.addEventListener('click', () => switchMode('quiz'));
            
            // æ–‡ä»¶åŠ è½½äº‹ä»¶
            languageSelect.addEventListener('change', loadVoiceOptionsForSelectedLanguage);
            loadFileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            
            // æµ‹éªŒæ¨¡å¼äº‹ä»¶
            quizPlayButton.addEventListener('click', playCurrentWordPronunciation);
            quizPlayExampleButton.addEventListener('click', playCurrentExamplePronunciation);
            quizKnowBtn.addEventListener('click', () => handleWordKnowledge(true));
            quizUnknownBtn.addEventListener('click', () => handleWordKnowledge(false));
            quizNextWordBtn.addEventListener('click', startNextQuizWord);
            quizExportBtn.addEventListener('click', exportUnknownWords);
            
            // å­¦ä¹ æ¨¡å¼äº‹ä»¶
            studyPrevBtn.addEventListener('click', () => {
                if (studyCurrentIndex > 0) {
                    stopStudyAutoPlay();
                    studyCurrentIndex--;
                    displayStudyWord();
                }
            });
            studyNextBtn.addEventListener('click', () => {
                if (studyCurrentIndex < allWordsData.length - 1) {
                    stopStudyAutoPlay();
                    studyCurrentIndex++;
                    displayStudyWord();
                }
            });
            studyPlayBtn.addEventListener('click', playStudyWord);
            studyPlayExampleBtn.addEventListener('click', async () => {
                const word = allWordsData[studyCurrentIndex];
                if (word && word.example) {
                    await playAmazonPolly(word.example);
                }
            });
            studyAutoPlayBtn.addEventListener('click', () => {
                if (studyCurrentAutoPlayMode === 'wordOnly') {
                    stopStudyAutoPlay();
                } else {
                    startStudyAutoPlay('wordOnly');
                }
            });
            studyAutoPlayWithExampleBtn.addEventListener('click', () => {
                if (studyCurrentAutoPlayMode === 'wordWithExample') {
                    stopStudyAutoPlay();
                } else {
                    startStudyAutoPlay('wordWithExample');
                }
            });

            // åŠ è½½ Polly è¯­è¨€å’ŒéŸ³è‰²
            loadAllPollyLanguagesAndVoices();
            
            // é»˜è®¤æ˜¾ç¤ºå­¦ä¹ æ¨¡å¼
            switchMode('study');
        }

        // å¡«å……è¯­è¨€é€‰æ‹©å™¨å¹¶è®¾ç½®é»˜è®¤è¯­è¨€ä¸ºè‹±è¯­ï¼ˆen-USï¼‰ä»¥åŠè¯¥è¯­è¨€ä¸‹çš„ç¬¬ä¸€ä¸ªéŸ³è‰²
        function populatePollyLanguageSelector() {
            const uniqueLanguageCodes = [...new Set(allPollyVoices.map(voice => voice.LanguageCode))].sort();
            languageSelect.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = t.msgSelectLanguage || 'é€‰æ‹©è¯­è¨€';
            languageSelect.appendChild(defaultOption);
            
            uniqueLanguageCodes.forEach(langCode => {
                const option = document.createElement('option');
                option.value = langCode;
                option.textContent = ALL_APP_DATA.pollyLanguageDisplayNames[langCode] || langCode;
                languageSelect.appendChild(option);
            });

            const defaultLang = 'en-US';
            const langOption = Array.from(languageSelect.options).find(option => option.value === defaultLang);
            if (langOption) {
                languageSelect.value = defaultLang;
            } else if (uniqueLanguageCodes.length > 0) {
                languageSelect.value = uniqueLanguageCodes[0];
            }

            loadVoiceOptionsForSelectedLanguage();
        }
    
        // æ ¹æ®é€‰ä¸­è¯­è¨€åŠ è½½éŸ³è‰²é€‰é¡¹
        function loadVoiceOptionsForSelectedLanguage() {
            const selectedLang = languageSelect.value;
            voiceSelect.innerHTML = '';
    
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = t.msgSelectVoice || 'é€‰æ‹©éŸ³è‰²...';
            voiceSelect.appendChild(defaultOption);
    
            if (!selectedLang || !allPollyVoices.length) {
                return;
            }
    
            const filteredVoices = allPollyVoices
                .filter(voice => voice && voice.LanguageCode === selectedLang)
                .sort((a, b) => (a.Name || '').localeCompare(b.Name || ''));
    
            if (filteredVoices.length === 0) {
                const noVoiceOption = document.createElement('option');
                noVoiceOption.value = '';
                noVoiceOption.textContent = t.msgNoVoicesForLang || 'æ­¤è¯­è¨€æˆ–å¼•æ“æ— å¯ç”¨éŸ³è‰²';
                voiceSelect.appendChild(noVoiceOption);
                return;
            }
    
            filteredVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.Id;
                const displayName = ALL_APP_DATA.pollyLanguageDisplayNames[voice.LanguageCode] || voice.LanguageCode;
                const engineLabel = (voice.SupportedEngines && voice.SupportedEngines.includes('neural')) ? 'Neural' : 'Standard';
                option.textContent = `${voice.Name} (${voice.Gender}, ${displayName}, ${engineLabel})`;
                voiceSelect.appendChild(option);
            });

            if (filteredVoices.length > 0) {
                voiceSelect.value = filteredVoices[0].Id;
            }
        }

        // DOM åŠ è½½å®Œæˆåè¿è¡Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
